---
import { getCollection } from "astro:content";
import Layout from "../layouts/Layout.astro";
import { config } from "../config";

export async function getStaticPaths({ paginate }) {
  const allPosts = await getCollection("posts");
  const sortedPosts = allPosts.sort(
    (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime(),
  );

  // Start from page 2 since page 1 is handled by index.astro
  const postsPerPage = config.pagination.postsPerPage;
  const totalPages = Math.ceil(sortedPosts.length / postsPerPage);

  // Only generate pages 2 and onwards
  const pages = [];
  for (let i = 2; i <= totalPages; i++) {
    const startIndex = (i - 1) * postsPerPage;
    const endIndex = startIndex + postsPerPage;
    const pagePosts = sortedPosts.slice(startIndex, endIndex);

    pages.push({
      params: { page: i.toString() },
      props: {
        posts: pagePosts,
        currentPage: i,
        totalPages: totalPages,
      },
    });
  }

  return pages;
}

const { posts, currentPage, totalPages } = Astro.props;
const canonicalURL = new URL(`/${currentPage}`, config.site.url);
---

<Layout
  title={`${config.site.title} - Page ${currentPage}`}
  description={config.site.description}
  canonicalURL={canonicalURL}
>
  <article>
    {
      posts.map((post) => (
        <section class="post-preview">
          <h2>
            <a href={`/posts/${post.slug}`}>{post.data.title}</a>
          </h2>
          <time datetime={post.data.pubDate.toISOString()}>
            {post.data.pubDate.toLocaleDateString("en-US", {
              year: "numeric",
              month: "long",
              day: "numeric",
            })}
          </time>
          {post.data.tags && post.data.tags.length > 0 && (
            <div class="tags-container">
              <ul class="tag-list">
                {post.data.tags.map((tag) => (
                  <li>
                    <a href={`/categories/${tag}`}>{tag}</a>
                  </li>
                ))}
              </ul>
            </div>
          )}
          <p>{post.data.description}</p>
          <a href={`/posts/${post.slug}`} class="read-more-link">
            {config.navigation.readMore}
          </a>
        </section>
      ))
    }
  </article>

  {
    totalPages > 1 && (
      <nav class="pagination">
        <div class="pagination-links">
          {currentPage > 1 ? (
            <a
              href={currentPage === 2 ? "/" : `/${currentPage - 1}`}
              class="pagination-link pagination-prev"
            >
              {config.navigation.previous}
            </a>
          ) : (
            <span class="pagination-link pagination-prev disabled">
              {config.navigation.previous}
            </span>
          )}
          <span class="pagination-info">
            Page {currentPage} of {totalPages}
          </span>
          {currentPage < totalPages ? (
            <a
              href={`/${currentPage + 1}`}
              class="pagination-link pagination-next"
            >
              {config.navigation.next}
            </a>
          ) : (
            <span class="pagination-link pagination-next disabled">
              {config.navigation.next}
            </span>
          )}
        </div>
      </nav>
    )
  }
</Layout>

<style>
  article {
    margin-bottom: 3rem;
  }

  .post-preview {
    margin-bottom: 3rem;
    padding-bottom: 3rem;
    border-bottom: 1px solid #e5e5e5;
  }

  .post-preview:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }

  .post-preview h2 {
    margin-bottom: 0.5rem;
  }

  .post-preview time {
    display: block;
    margin-bottom: 1rem;
  }

  .tags-container {
    margin-bottom: 1rem;
  }

  .tag-list {
    display: flex;
    flex-wrap: wrap;
    list-style: none;
    padding: 0;
    margin: 0;
    gap: 0.5rem;
  }

  .tag-list li a {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background-color: var(--color-gray-light);
    border-radius: 4px;
    font-size: 0.75rem;
    color: var(--color-gray-dark);
    text-decoration: none;
    transition: background-color 0.2s;
  }

  .tag-list li a:hover {
    background-color: var(--color-gray-medium);
    color: var(--color-black);
  }

  .post-preview p {
    color: #666;
    margin-bottom: 1rem;
  }

  .read-more-link {
    display: inline-block;
    position: relative;
    color: #000000;
    text-decoration: none;
    font-size: 0.875rem;
  }

  .read-more-link::after {
    content: "";
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 0;
    height: 1px;
    background-color: #000000;
    transition: width 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .read-more-link:hover::after {
    width: 100%;
  }

  .pagination {
    margin-top: 4rem;
    padding-top: 2rem;
    border-top: 1px solid #e5e5e5;
  }

  .pagination-links {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
  }

  .pagination-info {
    color: #666;
    font-size: 0.875rem;
  }

  .pagination-link {
    position: relative;
    color: var(--color-black);
  }

  .pagination-link::after {
    content: "";
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 0;
    height: 1px;
    background-color: var(--color-black);
    transition: width 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .pagination-link:hover::after {
    width: 100%;
  }

  .pagination-link.disabled {
    color: #999;
    cursor: not-allowed;
    opacity: 0.5;
  }

  .pagination-link.disabled::after {
    display: none;
  }
</style>
