---
import { getCollection } from "astro:content";
import Layout from "../../../layouts/Layout.astro";
import { config } from "../../../config";

export async function getStaticPaths({ paginate }) {
  const allPosts = await getCollection("posts");
  const allTags = allPosts.flatMap((post) => post.data.tags || []);
  const uniqueTags = [...new Set(allTags)];

  return uniqueTags.flatMap((tag) => {
    const filteredPosts = allPosts.filter((post) =>
      post.data.tags?.includes(tag)
    );
    const sortedPosts = filteredPosts.sort(
      (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime()
    );
    return paginate(sortedPosts, {
      params: { tag },
      pageSize: config.pagination.postsPerPage,
    });
  });
}

const { page } = Astro.props;
const { tag } = Astro.params;

const canonicalURL = new URL(
  `/categories/${tag}${page.currentPage > 1 ? `/${page.currentPage}` : ""}`,
  config.site.url
);
---

<Layout
  title={`Posts tagged with "${tag}"`}
  description={`Posts tagged with "${tag}"`}
  canonicalURL={canonicalURL}
>
  <article>
    <h1>Posts tagged with "{tag}"</h1>
    {
      page.data.map((post) => (
        <section class="post-preview">
          <h2>
            <a href={`/posts/${post.slug}`}>{post.data.title}</a>
          </h2>
          <time datetime={post.data.pubDate.toISOString()}>
            {post.data.pubDate.toLocaleDateString("en-US", {
              year: "numeric",
              month: "long",
              day: "numeric",
            })}
          </time>
          {post.data.tags && post.data.tags.length > 0 && (
            <div class="post-tags">
              {post.data.tags.map((t, index) => (
                <>
                  <a href={`/categories/${t}`}>{t}</a>
                  {index < post.data.tags.length - 1 && ' Â· '}
                </>
              ))}
            </div>
          )}
          <p>{post.data.description}</p>
          <a href={`/posts/${post.slug}`} class="read-more-link">
            {config.navigation.readMore}
          </a>
        </section>
      ))
    }
  </article>

  {
    page.totalPages > 1 && (
      <nav class="pagination">
        <div class="pagination-links">
          {page.url.prev ? (
            <a href={page.url.prev} class="pagination-link pagination-prev">
              {config.navigation.previous}
            </a>
          ) : (
            <span class="pagination-link pagination-prev disabled">
              {config.navigation.previous}
            </span>
          )}
          <span class="pagination-info">
            Page {page.currentPage} of {page.totalPages}
          </span>
          {page.url.next ? (
            <a href={page.url.next} class="pagination-link pagination-next">
              {config.navigation.next}
            </a>
          ) : (
            <span class="pagination-link pagination-next disabled">
              {config.navigation.next}
            </span>
          )}
        </div>
      </nav>
    )
  }
</Layout>

<style>
  article {
    margin-bottom: 3rem;
  }

  .post-preview {
    margin-bottom: 3rem;
    padding-bottom: 3rem;
    border-bottom: 1px solid #e5e5e5;
  }

  .post-preview:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }

  .post-preview h2 {
    margin-bottom: 0.5rem;
  }

  .post-preview time {
    display: block;
    margin-bottom: 1rem;
  }

  .post-tags {
    font-size: 0.8em;
    color: #999;
    margin-bottom: 1rem;
    line-height: 1.5;
  }

  .post-tags a {
    color: #999;
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .post-tags a:hover {
    color: var(--color-black);
  }

  .post-preview p {
    color: #666;
    margin-bottom: 1rem;
  }

  .read-more-link {
    display: inline-block;
    position: relative;
    color: #000000;
    text-decoration: none;
    font-size: 0.875rem;
  }

  .read-more-link::after {
    content: "";
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 0;
    height: 1px;
    background-color: #000000;
    transition: width 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .read-more-link:hover::after {
    width: 100%;
  }

  .pagination {
    margin-top: 4rem;
    padding-top: 2rem;
    border-top: 1px solid #e5e5e5;
  }

  .pagination-links {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
  }

  .pagination-info {
    color: #666;
    font-size: 0.875rem;
  }

  .pagination-link {
    position: relative;
    color: var(--color-black);
  }

  .pagination-link::after {
    content: "";
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 0;
    height: 1px;
    background-color: var(--color-black);
    transition: width 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .pagination-link:hover::after {
    width: 100%;
  }

  .pagination-link.disabled {
    color: #999;
    cursor: not-allowed;
    opacity: 0.5;
  }

  .pagination-link.disabled::after {
    display: none;
  }
</style>
